<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/static/images/favicon-32x32.png" sizes="32x32">

  <title>Create Route</title>
  <link rel="stylesheet" type="text/css" href="../static/css/project_files/ControlFullScreen.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.0.5/dist/geosearch.css" />
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.css"
    integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
    crossorigin="">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"
    integrity="sha512-5A8nwdMOWrSz20fDsjczgUidUBR8liPYU+WymTZP1lmY9G6Oc7HlZv156XqnsgNUzTyMefFTcsFH/tnJE/+xBg=="
    crossorigin="anonymous" />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
  <!-- Standard CSS & JavaScript -->
  <link rel="stylesheet" type="text/css" href="../static/css/libraries/common/global.css">
  <link rel="stylesheet" type="text/css" href="../static/css/libraries/common/loading.css">
  <link rel="stylesheet" type="text/css" href="../static/css/libraries/bootstrap-3.3.7/bootstrap.min.css">

  <link rel="stylesheet" type="text/css" href="../static/css/libraries/bootstrap-table-1.16.0/bootstrap-table.min.css">
  <link rel="stylesheet" type="text/css"
    href="../static/css/libraries/bootstrapValidator-0.5.1/bootstrapValidator.min.css">

  <link rel="stylesheet" type="text/css" href="../static/css/libraries/select2/select2.min.css">
  <link rel="stylesheet" type="text/css" href="../static/css/libraries/select2/select2-bootstrap.css">
  <link rel="stylesheet" type="text/css" href="../static/css/project_files/headerfooter.css">
  <link rel="stylesheet" type="text/css" href="../static/css/project_files/create_route.css">
  <script src="../static/js/libraries/jquery-2.1.3/jquery-2.1.3.min.js"></script>
  <script src="../static/js/libraries/bootstrap-3.3.7/bootstrap.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js"></script>
  <script src="../static/js/libraries/bootstrap-table-1.16.0/bootstrap-table.min.js"></script>

  <!--   <script src="/static/js/tableExport.js"></script>
  <script src="/static/js/bootstrap-table-export.js"></script>
 -->
  <script src="../static/js/libraries/bootstrapValidator-0.5.1/bootstrapValidator.min.js"></script>
  <script src="../static/js/libraries/select2/select2.min.js"></script>
  <script src="../static/js/libraries/common/common.js"></script>

  <style>

  </style>
</head>


<body>
  <!-- Preloader -->
  <div id="preloader" class="displayNone">
    <div id="status">&nbsp;</div>
  </div>

  <!-- header Starts -->
  <nav class="navbar">
    <div class="dtplus-border">

      <!-- logo and top bar -->
      <div class="cargofl-header flex-container">
        <span class="flex-item-3">
          <img src="../static/images/logo.png" class="pull-left cargofl-site-logo">
        </span>
        <span class="flex-item-3">
          <span class="cargofl-site-title"></span>
        </span>
        <span class="flex-item-3">
          <div class="pull-right cargofl-header-text">

          </div>
          <div id="contact" class="collapse pull-right">
            <code>contact@innoctive.com / +91 - 83290 83054</code>
          </div>
        </span>
      </div>

      <!-- menu bar -->
      <div>
        <ul class="nav navbar-nav cargofl-menubar">

          <li class="dropdown">
            <a class="dropdown-toggle" href="/trip-board"><i class="fa fa-home"></i></a>
          </li>

          <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Operations <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="/trip-board">Tripboard</a></li>
              <li><a href="/route-planning">Route Planning</a></li>
            </ul>
          </li>

          <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Master <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="/metadata">Metadata</a></li>
              <!-- <li><a href="comingsoon.html">Rate</a></li> -->
              <li><a href="/resource">Resources</a></li>
            </ul>
          </li>


          <!-- <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">Analytics <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="comingsoon.html">Vehicle Dashboard</a></li>            
            <li><a href="comingsoon.html">Reports</a></li>
          </ul>
        </li> -->

          <!-- <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">Settings <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="comingsoon.html">Profile</a></li>
            <li><a href="comingsoon.html">Eway Bill</a></li>
            <li><a href="comingsoon.html">Wallet</a></li>
            <li><a href="comingsoon.html">About Me</a></li>
            <li><a href="comingsoon.html">Configurations</a></li>
            <li><a href="comingsoon.html">Booking Configurations</a></li>
            <li><a href="comingsoon.html">Payment Package</a></li>
          </ul>
        </li> -->

          <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Support <span class="caret"></span></a>

            <ul class="dropdown-menu">
              <li><a href="/contact-us">Contact Us</a></li>
              <!-- <li><a href="comingsoon.html">FAQ's</a></li>
            <li><a href="comingsoon.html">Trainings</a></li> -->
            </ul>

          </li>

        </ul>
      </div>
    </div>
  </nav>
  <!-- header ends -->



  <div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper" style="height: 610px !important; overflow-x: hidden;">
      <ul class="sidebar-nav" id="side_bar">
        <form id="create_route_form" style="width:100% !important;">
          <div style="margin-bottom: 30px;letter-spacing: 1px;margin-left: 15px;">
            <h2>Create A Route</h2>
          </div>

          <div class="row" style="margin-left: 7px;margin-right: 5px;margin-bottom: 5px;">
            <div class="col-md-6">
              <div class="form-group">
                <div class="inputGroupContainer">
                  <div class="input-group">
                    <span class="input-group-addon" style="color: #337ab7; background: #CEE2F3;"><i
                        class="glyphicon glyphicon-road"></i></span>
                    <input name="route_name" id="route_name" placeholder="Enter a Route Name" class="form-control"
                      type="text" required>
                  </div>
                </div>
              </div>
              <!-- <div class="form-group">
                <input type="text" class="form-control" id="route_name" placeholder="Enter a Route Name" required>
              </div> -->
            </div>
          </div>


          <div class="row" style="margin-left: 7px; margin-right: 5px;">
            <div class="col-md-6">
              <div class="form-group">
                <div class="inputGroupContainer">
                  <div class="input-group">
                    <span class="input-group-addon" style="color: #498834; background: #D4FFC5; font-size: 18px;"><i
                        class="glyphicon glyphicon-map-marker"></i></span>
                    <input name="start_point" id="start_point" placeholder="Start Point" class="form-control"
                      type="text" required>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <div class="inputGroupContainer">
                  <div class="input-group">
                    <span class="input-group-addon" style="color: #E91D1D; background: #FFC5C5; font-size: 18px;"><i
                        class="glyphicon glyphicon-map-marker"></i></span>
                    <input name="end_point" id="end_point" placeholder="End Point" class="form-control" type="text"
                      required>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin: auto 0px;">
            <div class="col-lg-6">
              <div class="form-group" style="margin-left: 10px;margin-top: 5px;"> <label
                  class="control-label">Notes</label>
                <div class="inputGroupContainer">
                  <div class="input-group" style="width: 97%;"> <span class="input-group-addon text-center"><i
                        class="glyphicon glyphicon-pencil"></i></span> <textarea class="form-control" name="route_notes"
                      id="route_notes" rows="2" placeholder="Add Notes here.."></textarea> </div>
                </div>
              </div>
            </div>

            <div class="col-lg-3" style="margin-top: 5px; padding-right: 0px;padding-left: 0px;">
              <div class="form-group" style="margin-left: 10px;margin-top: 5px;"> <label class="control-label">Total
                  Route Expense</label>
                <div class="text-center" style="font-size: 25px;letter-spacing: 3px;margin-top: 7px;"
                  id="total_route_expense">
                </div>
              </div>
            </div>

            <div class="col-lg-3" style="margin-top: 5px; padding: 0px!important;">
              <div class="form-group" style="margin-left: 10px;margin-top: 5px;"> <label class="control-label"
                  style="margin-left: 15px;">Total
                  Checkpoints</label>
                <div class="text-center" style="font-size: 25px;letter-spacing: 3px;margin-top: 7px;"
                  id="total_checkpt"></div>
              </div>
            </div>


          </div>
          <div id="main-conent" class="container">

            <ul style="margin:0px;" id="accordion_ul">

            </ul>

          </div>


          <button type="submit" class="btn btn-primary center-block" id="finish_route_planning_btn"
            style="margin-top: 15px; margin-bottom: 0px;letter-spacing: 1px;">Finish Route Planning</button>

        </form>

      </ul>
    </div>
    <!-- /#sidebar-wrapper -->
    <!-- Page Content -->
    <div id="page-content-wrapper">
      <div class="container-fluid" style="padding: 0px !important;">
        <div class="row base-row" style="width: 100%">
          <div class="col-lg-12" style="margin-left: 10px; padding-right: 5px;">


            <div class="row" style="width: 100%;">
              <div class="col-lg-1" style=" padding: 0px; padding-left: 30px;padding-bottom: 10px;width: 60px;">
                <h3 style="width: 40px;"><a href="#menu-toggle" class="gradient-menu" id="menu-toggle"></a></h3>
              </div>
              <!-- <div class="col-lg-6" style="margin-top: 16px;">
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="Search" id="txtSearch" />
                  <div class="input-group-btn">
                    <button class="btn btn-primary" type="submit"> -->
              <!-- <span class="glyphicon glyphicon-search"></span>  Search Checkpoint -->
              <!-- </button>
                  </div>
                </div>
              </div> -->

              <div class="col-lg-7" style="margin-top: 18px; display: flex;">
                <label style="margin-top: 5px; ">Radius (in meters) :</label>
                <div class="input-group" style="margin-left: 15px;width: 130px;">

                  <input type="text" class="form-control" placeholder="Enter Circle Radius (in meters)" id="radius"
                    readonly onkeypress='return isNumberKey(event)' />
                  <div class="input-group-btn">
                    <button class="btn btn-primary" id="edit_radius">
                      Unlock
                    </button>

                    <button class="btn btn-primary hidden" id="submit_radius">
                      Lock
                    </button>
                  </div>
                </div>
              </div>



            </div>



            <!-- you can use tables or divs for the overall layout -->
            <!-- you can use tables or divs for the overall layout -->
            <div>
              <div id="map"></div>

            </div>
            <!-- <h1>Simple Sidebar</h1> -->
          </div>
        </div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->
  </div>
  <!-- /#wrapper -->






  <!-- Modal -->
  <div id="myModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title" style="letter-spacing: 0.8px;">Add Expense</h4>
        </div>

        <div class="modal-body">
          <div class="row" style="margin-left: 10px;margin-right: 5px;margin-top: 20px; margin-bottom: 25px;">
            <div class="row">
              <div class="col-md-4">
                <p class="pull-right"
                  style="font-weight: bolder;font-size: 15px;padding-top: 5px;letter-spacing: 0.5px;">Expense Type :
                </p>
              </div>
              <div class="col-md-6">
                <div class="form-group">

                  <select id="select" name="select" class="form-control" style="cursor: pointer;">
                    <option value="select" hidden>Select Expense Type</option>
                  </select>

                </div>
              </div>

            </div>
            <div class="form-group"></div>
            <div class="row">
              <div class="col-md-4">
                <p class="pull-right"
                  style="font-weight: bolder;font-size: 15px;padding-top: 5px;letter-spacing: 0.5px;">Amount (in
                  Rs.) :
                </p>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <input type="text" class="form-control " name="expense" id="expense"
                    placeholder="&#8377; Enter Expense in Rs." required onkeypress='return isNumberKey(event)'>
                </div>
              </div>

            </div>

          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="add_expense_btn" data-dismiss="modal"
            style="letter-spacing: 0.8px;" onclick="addExpense()">Add
            Expense</button>
          <!-- <button type="button" class="btn btn-primary hidden" data-dismiss="modal" id="save_btn">save</button> -->
          <button type="button" class="btn btn-default" data-dismiss="modal" id="close_modal"
            style="letter-spacing: 0.8px;">Close</button>
        </div>
      </div>

    </div>
  </div>
  <!-- modal ends -->












  <!-- Footer Starts -->
  <div class="cargofl-footer flex-container">
    <span class="flex-item-3">
      <a href="#">Privacy Policy</a> | <a href="#">Terms &amp; Conditions</a>
    </span>
    <span class="flex-item-3 text-center">
      CargoFL Version 1.1.2
    </span>
    <span class="flex-item-3 text-right">
      Powered by CargoFL (Innoctive Technologies Pvt Ltd)
    </span>
  </div>
  <!-- Make sure you put this AFtER leaflet.js, when using with leaflet -->


  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- <script type="text/javascript" src="../static/js/project_files/geosearch.js"></script> -->
  <!-- Make sure you put this AFtER leaflet.js, when using with leaflet -->
  <script src="../static/js/project_files/ControlFullScreen.js"></script>
  <script type="module" src="https://unpkg.com/leaflet-geosearch@3.0.5/dist/geosearch.umd.js"></script>
  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.5.3/dist/esri-leaflet.js"
    integrity="sha512-K0Vddb4QdnVOAuPJBHkgrua+/A9Moyv8AQEWi0xndQ+fqbRfAFd47z4A9u1AW/spLO0gEaiE1z98PK1gl5mC5Q=="
    crossorigin=""></script>

  <!-- Load Esri Leaflet Geocoder from CDN -->

  <script src="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.js"
    integrity="sha512-HrFUyCEtIpxZloTgEKKMq4RFYhxjJkCiF5sDxuAokklOeZ68U2NPfh4MFtyIVWlsKtVbK5GD2/JzFyAfvT5ejA=="
    crossorigin=""></script>


  <script type="text/javascript" src="../static/js/constants/validation_message.js"></script>
  <script type="text/javascript" src="../static/js/constants/api_end_points.js"></script>
  <script type="text/javascript" src="../static/js/constants/html_page_end_points.js"></script>
  <script type="text/javascript" src="../static/js/libraries/QuickAccord.js"></script>
  <script type="text/javascript" src="../static/js/libraries/QuickAccord.min.js"></script>

  <script type="module">

    $(".accordion-trigger").QuickAccord();
    // you want to get it of the window global
    const provider = new GeoSearch.OpenStreetMapProvider();

    // Either get GeoSearch from the window global, or import from `leaflet-geosearch`
    // import * as GeoSearch from 'leaflet-geosearch';

    var map = L.map('map', {
      fullscreenControl: true,
      fullscreenControlOptions: {
        position: 'topleft'
      },
      zoomDelta: 0.25,
      zoomSnap: 0
    }).setView([19.1590, 72.9986], 12);
    // var map = L.map('map').setView([19.1590, 72.9986], 12);
    var attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

    // Create a Tile Layer and add it to the map
    var tiles = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution }).addTo(map);

    var draggable = new L.Draggable(map);
    draggable.enable();
    const search = new GeoSearch.GeoSearchControl({
      provider: new GeoSearch.OpenStreetMapProvider(),
      style: 'bar',
      autoComplete: true, // optional: true|false  - default true
      autoCompleteDelay: 250,
      showMarker: false, // optional: true|false  - default true
      showPopup: false, // optional: true|false  - default false
      marker: {
        // optional: L.Marker    - default L.Icon.Default
        icon: new L.Icon.Default(),
        draggable: false,
      },
      resultFormat: ({ result }) => result.label, // optional: function    - default returns result label
      maxMarkers: 0, // optional: number      - default 1
      retainZoomLevel: false, // optional: true|false  - default false
      animateZoom: true, // optional: true|false  - default true
      autoClose: true, // optional: true|false  - default false
      searchLabel: 'Search Checkpoint', // optional: string      - default 'Enter address'
      keepResult: false, // optional: true|false  - default false
      updateMap: true, // optional: true|false  - default true
    });

    map.addControl(search);


    map.on('click', onMapClick);


    var expense_list_id = '';
    var expense_id = 1;
    var radius = 50;
    var checkpt_count = 0;
    var markers = new Array();
    var popup = L.popup();

    var expense_array = [];
    var empty_expense = [];
    var checkpt_array = [];
    var checkpt_object = {};
    var temp_marker = [];
    var marker_array = [];
    var marker_object = {};
    var marker_flag = 'true';
    var circles_array = new Array();
    var polyline_array = new Array();
    var numItems = 0;

    var geocodeService = L.esri.Geocoding.geocodeService();
    $("#total_route_expense").html("Rs. " + total_route_expense + "/-");
    var checkpt_length = $('.accordion-trigger').length;
    $("#total_checkpt").html(checkpt_length);

    function onMapClick(e) {




      if (radius != null && $('#radius').val() != '' && radius != 0) {
        if (checkpt_count < 0) {
          checkpt_count = 0;

        }
        geocodeService.reverse().latlng(e.latlng).run(function (error, result) {
          if (error) {
            return;
          }
          var marker_address = result.address.Address + result.address.Block + result.address.City + ', ' + result.address.Subregion + ', ' + result.address.Region + ', ' + result.address.CountryCode;
          // L.marker(result.latlng).addTo(map).bindPopup(marker_address + '<br>' + "Pincode - " + result.address.Postal).openPopup();
          // popup
          //   .setLatLng(e.latlng)
          //   .setContent(marker_address + '<br>' + "Pincode - " + result.address.Postal)
          //   .openOn(map);

          // console.log(result);
          // if (checkpt_count == 0) {
          //   $('#start_point').val(marker_address);
          //   document.getElementById("end_point").value = '';
          //   $("#start_point").prop("readonly", false);
          //   $("#end_point").prop("readonly", true);

          // }
          // else if (checkpt_count > 0) {
          //   document.getElementById("end_point").value = '';
          //   $('#end_point').val(marker_address);
          //   $("#end_point").prop("readonly", false);
          // }



          // popup
          //   .setLatLng(e.latlng)
          //   .setContent("checkpoint " + (checkpt_count + 1))
          //   .openOn(map);

          var marker = new L.Marker(e.latlng).addTo(map).bindPopup(marker_address + '<br>' + "Pincode - " + result.address.Postal).openPopup();
          // $('.leaflet-control-geosearch form .results').removeClass('active');
          // alert($('.leaflet-control-geosearch form').html());
          // $('.leaflet-control-geosearch form').removeClass('active');
          // $('.leaflet-control-geosearch form').removeClass('open');
          $('.glass').val('');

          var circle = new L.circle(e.latlng, { radius: radius, color: 'red' }).addTo(map);
          // var polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
          map.addLayer(marker);
          map.addLayer(circle);
          // console.log(circle);
          circles_array[circle._leaflet_id] = circle;
          markers[marker._leaflet_id] = marker;
          // console.log(markers);
          // alert("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng);
          temp_marker = [];
          if (marker_array.length > 0) {
            for (var i = 0; i < marker_array.length; i++) {
              if (marker_array[i][0] == e.latlng.lat && marker_array[i][1] == e.latlng.lng) {
                alert("Marker Already Exist at [" + e.latlng.lat + ", " + e.latlng.lng + "]");
                marker_flag = 'false';
              }
            }
            if (marker_flag == 'true') {
              // alert("FOr Loop True");
              temp_marker.push(e.latlng.lat);
              temp_marker.push(e.latlng.lng);
              // console.log("FOR LOOP Temp Marker Array -> " + temp_marker);
              marker_array.push(temp_marker);
              // console.log("FOR LOOP Marker Array -> " + marker_array);
            }
          }
          else if (marker_array.length == 0) {
            // alert("else length==0");
            temp_marker.push(e.latlng.lat);
            temp_marker.push(e.latlng.lng);
            // console.log("Temp Marker Array -> " + temp_marker);
            marker_array.push(temp_marker);
            // console.log("Marker Array -> " + marker_array);
          }

          // console.log(marker_array);

          var polyline = L.polyline(marker_array, { color: 'red' }).addTo(map);
          map.addLayer(polyline);
          polyline_array[polyline._leaflet_id] = polyline;

          // zoom the map to the polyline    
          if (checkpt_count > 0) {
            map.fitBounds(polyline.getBounds());

          }
          // $('#accordion_ul').append('<li>Marker ' + marker._leaflet_id + ' - <a href="#" class="remove" id="' + marker._leaflet_id + '">remove</a></li>');

          $('#accordion_ul').append('<li class="animate-left" id="li' + (checkpt_count + 1) + '">\
        <a href = "#accordion'+ (checkpt_count + 1) + '" class= "accordion-trigger" data-accord-group="group1" aria-controls="accordion' + (checkpt_count + 1) + '" id="' + (checkpt_count + 1) + '" >\
        <img src="../static/images/gmap.png" width="20" style="margin-right: 5px;" /><span class="acc_title" id="'+ e.latlng.lat + 'd' + e.latlng.lng + '"> ' + marker_address + '</span>\
        <div class="btn-danger pull-right remove btn-sm" style="margin-top: 8px; margin-right: 20px;" id="\'' + marker._leaflet_id + 'd' + circle._leaflet_id + 'm' + polyline._leaflet_id + '\'" >Remove</div>\
        </a>\
      <div id="accordion'+ (checkpt_count + 1) + '" class="accordion-content collapsed">\
        <form method="POST" id="form'+ (checkpt_count + 1) + '">\
        <div class="expenses">\
          <div class="row " id="expense_list'+ (checkpt_count + 1) + '" style="margin:10px 20px;">\
          </div>\
        </div>\
        <div class="row" style="margin: 5px auto;margin-bottom: 10px;">\
          <div class="col-lg-8" style="padding-left:10px !important;">\
            <div class="form-group">\
              <label class="control-label row" style="margin: auto 0px;">Notes</label>\
              <div class="inputGroupContainer row" style="margin: auto 50px; margin-right: 0px;margin-left:0px !important;">\
                <div class="input-group">\
                  <span class="input-group-addon text-center"><i class="glyphicon glyphicon-pencil"></i></span>\
                  <textarea class="form-control" name="checkpoint_notes" id="checkpoint_notes'+ (checkpt_count + 1) + '" rows="2" placeholder="Add Notes here.."></textarea>\
                </div>\
              </div>\
            </div>\
          </div>\
        </div>\
        <div class="row" style="margin: 5px auto;margin-bottom: 10px; margin-left:0px !important;">\
          <div class="col-lg-8" style="padding-left:10px !important;">\
            <div class="form-group">\
              <label class="control-label row" style="margin: auto 0px;">Offset Time</label>\
              <div class="inputGroupContainer row" style="margin: auto 0px; margin-right: 0px;">\
                <div class="input-group">\
                  <input class="form-control" type="time" name="offset_time" id="offset_time'+ (checkpt_count + 1) + '">\
                </div>\
              </div>\
            </div>\
          </div>\
        </div>\
        <div class="row" style="margin-left: 10px;">\
          <div class="button-wrapper pull-left" style="margin-bottom: 10px;">\
            <a href="#myModal" data-toggle="modal" data-target="#myModal">\
              <div class="btn btn-primary" id="add_expense_'+ (checkpt_count + 1) + '" onclick="setExpenseListId(\'expense_list' + (checkpt_count + 1) + '\');">\
                <span >Add Expenses</span>\
              </div>\
            </a>\
          </div>\
        </div>\
      </div>\
      <hr>\
      </form>\
            </li >\
        ');


          $(".accordion-trigger").QuickAccord();
          numItems = 0;
          numItems += $('.accordion-trigger').length;
          // alert(numItems);
          // if (numItems > 0) {
          //   $('#finish_route_planning_btn').removeClass('hidden');
          // }



          var checkpt_length = $('.accordion-trigger').length;
          $("#total_checkpt").html(checkpt_length);

          // Remove a marker
          $('.remove').on("click", function () {
            // checkpt_count -= 1;

            var leaflet_id = $(this).attr('id');
            // alert(leaflet_id)
            var n = leaflet_id.indexOf("d");
            var t = leaflet_id.indexOf("m");
            var end = leaflet_id.length - 1;
            var marker_leaflet_id = leaflet_id.slice(1, n);
            var circle_leaflet_id = leaflet_id.slice(n + 1, t);
            var polyline_leaflet_id = leaflet_id.slice(t + 1, end);
            // alert(marker_leaflet_id);
            // alert(circle_leaflet_id);
            // alert(polyline_leaflet_id);
            // alert(marker_leaflet_id);
            // console.log(markers[marker_leaflet_id]._latlng.lng);
            // alert("Lat, Lng -> [" + markers[marker_leaflet_id]._latlng.lat + ", " + markers[marker_leaflet_id]._latlng.lng + "]");
            for (var i = 0; i < marker_array.length; i++) {
              if ((markers[marker_leaflet_id]._latlng.lat == marker_array[i][0]) && (markers[marker_leaflet_id]._latlng.lng == marker_array[i][1])) {
                marker_array.splice(i, 1);
              }
            }

            // console.log("in Remove" + marker_array.length);
            // var polyline = L.polyline(marker_array, { color: 'blue' }).addTo(map);
            // Remove the marker and Cirlce
            map.removeLayer(markers[marker_leaflet_id]);
            map.removeLayer(circles_array[circle_leaflet_id]);
            map.removeLayer(polyline_array[polyline_leaflet_id]);

            // Remove the link
            // alert($(this).closest('li').attr('id').slice(2));
            var form_id_no = $(this).closest('li').attr('id').slice(2);

            var form_data = $('#form' + form_id_no).serializeArray();
            // console.log(form_data);
            var j = 0;
            var temp_total_expense = 0;

            while (j < form_data.length) {

              if (form_data[j].name == "expense_type" && form_data[j + 1].name == "expense_amount") {
                temp_total_expense += parseInt(form_data[j + 1].value.slice(4, -2));
                j += 2;
              }
              if (form_data[j].name == "checkpoint_notes") {
                j += 1;
              }
              if (form_data[j].name == "offset_time") {
                j += 1;
              }

            }
            // alert(temp_total_expense);
            total_route_expense -= temp_total_expense;
            $("#total_route_expense").html("Rs. " + total_route_expense + "/-");



            // $(this).closest('li').attr('id');
            $(this).closest('li').remove();


            // Remove the marker from the array
            delete markers[marker_leaflet_id];
            delete circles_array[circle_leaflet_id];
            delete polyline_array[polyline_leaflet_id];
            numItems = 0;
            numItems += $('.accordion-trigger').length;
            // if (numItems < 1) {

            //   document.getElementById("start_point").value = '';
            //   $("#start_point").prop("readonly", true);

            // }
            // if (numItems < 1) { $('#finish_route_planning_btn').addClass('hidden'); }
            // if (numItems == 1) {
            //   document.getElementById("end_point").value = '';
            //   $("#end_point").prop("readonly", true);
            // }
            var checkpt_length = $('.accordion-trigger').length;
            $("#total_checkpt").html(checkpt_length);

          });

          // polyline.on('dblclick', function (e) {
          //   map.removeLayer(this);
          // });


          checkpt_count += 1;
        });
      }

      else {
        alert(enter_radius);

      }

    }

    function isEmpty(el) {
      return !$.trim(el.html())
    }


    $(document).ready(function () {



      $('#radius').val(radius);

      var login_data = JSON.parse(localStorage.getItem('login_data'));

      $('.cargofl-header-text').html('Welcome, <b>' + login_data.user_name + '</b>&nbsp;<br />\
            <a alt="Logout" style="cursor: pointer;" href="/cloud"><img class="pull-right" style="height: 20px;" src="../static/images/logout.png"></img></a>');

      $('#edit_radius').click(function () {
        $('#edit_radius').addClass("hidden");
        $('#submit_radius').removeClass("hidden");
        $("#radius").prop("readonly", false);
      });

      $('#submit_radius').click(function () {
        radius = 0;
        var y = $('#radius').val();

        if (y != '') {
          var x = parseInt(y);
          radius += x;
          $('#submit_radius').addClass("hidden");
          $('#edit_radius').removeClass("hidden");
          $("#radius").prop("readonly", true);
        }
        else {
          alert(invalid_radius);
        }

        // circles_array.forEach(changeRadius);

      });




      var expense_data = JSON.stringify({
        "metadata_type": "ExpenseType",
        "franchise_id": login_data.franchise_id
      });

      $.ajax({
        type: "POST",
        url: base_url + get_metadata_by_type,
        data: expense_data,
        contentType: 'application/json',
        success: function (data) {

          if (data['code'] == "000") {
            console.log(data);
            for (var i = 0; i < data.data.length; i++) {
              $('#select').append('<option value="' + data.data[i].element + '" >' + data.data[i].element + '</option>');
            }
          } else {
            alert(data.message);
          }
        },
        error: function (data) {
          alert(data.responseJSON.message);
        }
      });







      $("#create_route_form").submit(function (event) {
        event.preventDefault();
        var present_empty_expense_list = false;
        if ($('.accordion-trigger').length == 0) {
          alert("Please add atleast 1 Checkpoint");
        }
        // else if ($('.accordion-trigger').length == 1) {
        //   alert("Please Select a Destination");
        // }
        // else if ($('.accordion-trigger').length == 2) {
        //   alert("Please add atleast 1 Checkpoint");
        // }

        else {

          // alert($("div.accordion-content:eq(1)").attr('id'));
          // alert($('#accordion_ul form').length);

          for (var i = 0; i < $('.accordion-content').length; i++) {
            // var form_data = $('#form' + (i + 1)).serializeArray();
            var form_data = $('div.accordion-content:eq(' + i + ') > form').serializeArray();
            // console.log(form_data);
            var j = 0;
            var expense_array = [];
            console.log(form_data);
            while (j < form_data.length) {
              var expense_object = {};
              if (form_data[j].name == "expense_type" && form_data[j + 1].name == "expense_amount") {
                expense_object.expense_amount = form_data[j + 1].value.slice(4, -2);
                expense_object.expense_type = form_data[j].value;

                expense_array.push(expense_object);
                j += 2;
              }
              if (form_data[j].name == "checkpoint_notes") {
                j += 1;
              }
              if (form_data[j].name == "offset_time") {
                j += 1;
              }

            }
            // console.log(i + 1);
            // console.log(expense_array);

            var accordion_id = $("a.accordion-trigger:eq(" + i + ")").attr('id');
            var accordion_title = $("a.accordion-trigger:eq(" + i + ") > .acc_title").text();
            var accordion_latlng = $("a.accordion-trigger:eq(" + i + ") > .acc_title").attr('id');

            var n = accordion_latlng.indexOf("d");
            var accordion_lat = accordion_latlng.slice(0, n);
            var accordion_lng = accordion_latlng.slice(n + 1);
            // alert(accordion_title);
            // alert(accordion_latlng);
            // alert(accordion_lat);
            // alert(accordion_lng);
            // alert(accordion_id);

            // alert();
            var time = $('#offset_time' + (i + 1)).val();
            if (time == null || time == "") {
              offset_time = 0;
            }
            else {
              var timeParts = time.split(":");
              var offset_time = (+timeParts[0] * (60000 * 60)) + (+timeParts[1] * 60000);
            }




            if (expense_array.length == 0) {
              present_empty_expense_list = true;
            }


            // var present = 'false';
            // for (var i = 0; i < empty_expense.length; i++) {

            //   if (empty_expense[i] == accordion_id) {

            //     empty_expense.splice(i, 1);
            //     console.log("delete Duplicate function");
            //     console.log(empty_expense);

            //   }
            //   else {
            //     continue;
            //   }
            // }

            // if (expense_array.length == 0) {

            //   empty_expense.push(accordion_id);
            //   // alert(empty_expense);
            //   console.log("if expense not present");
            //   console.log(empty_expense);

            // }

            // else if (expense_array.length > 0) {

            //   for (var i = 0; i < empty_expense.length; i++) {
            //     if (empty_expense[i] == accordion_id) {

            //       empty_expense.splice(i, 1);
            //       console.log("delete function");
            //       console.log(empty_expense);


            //     }
            //     else {
            //       continue;
            //     }
            //   }
            // }



            checkpt_object.route_checkpoint_name = accordion_title;
            checkpt_object.latitude = accordion_lat;
            checkpt_object.longitude = accordion_lng;
            checkpt_object.notes = $('#checkpoint_notes' + (i + 1)).val();
            checkpt_object.sequence_number = i + 1;
            checkpt_object.offset_in_millis = offset_time;
            checkpt_object.expenses = expense_array;

            checkpt_array.push(checkpt_object);
            checkpt_object = {};

            // for loop ends
          }

          // console.log(checkpt_array);
          // alert(present_empty_expense_list);
          if (present_empty_expense_list === false) {
            var data_to_send = JSON.stringify({
              "route_name": $('#route_name').val(),
              "start_point": $('#start_point').val(),
              "end_point": $('#end_point').val(),
              "notes": $('#route_notes').val(),
              "login_id": login_data.login_id,
              "franchise_id": login_data.franchise_id,
              "checkpoints": checkpt_array
            });
            // console.log(data_to_send);

            $.ajax({
              type: "POST",
              url: base_url + create_route,
              data: data_to_send,
              contentType: 'application/json',
              beforeSend: function () {
                $('#preloader').removeClass('displayNone');
                $('#status').show();
              },
              complete: function () {
                $('#status').fadeOut(); // will first fade out the loading animation 
                $('#preloader').delay(400).fadeOut('slow'); // will fade out the white DIV that covers the website. 
                $('body').delay(400).css({ 'overflow': 'visible' });
                $('#preloader').addClass('displayNone');
              },
              success: function (data) {

                if (data['code'] == "000") {
                  // alert(data.message);
                  // console.log(data);
                  localStorage.setItem("add_route", "true");
                  window.location.href = '/route-planning';

                } else {
                  localStorage.setItem("add_route", "false");
                  alert(data.message);
                }
              },
              error: function (data) {
                localStorage.setItem("add_route", "false");
                alert(data.responseJSON.message);
                // alert("ERROR : Contact Administrator");
              }
            });
          }
          else {
            alert("Expense List Can't be empty, Add Expense & try again..");
          }


        }

      });

      // document ready ends
    });



    // create a fullscreen button and add it to the map
    L.control.fullscreen({
      position: 'bottomright', // change the position of the button can be topleft, topright, bottomright or bottomleft, defaut topleft
      title: 'Show me the fullscreen !', // change the title of the button, default Full Screen
      titleCancel: 'Exit fullscreen mode', // change the title of the button when fullscreen is on, default Exit Full Screen
      content: null, // change the content of the button, can be HTML, default null
      forceSeparateButton: true, // force seperate button to detach from zoom buttons, default false
      forcePseudoFullscreen: true, // force use of pseudo full screen even if full screen API is available, default false
      fullscreenElement: false // Dom element to render in full screen, false by default, fallback to map._container
    }).addTo(map);

    // events are fired when entering or exiting fullscreen.
    // map.on('enterFullscreen', function () {
    //   console.log('entered fullscreen');
    // });

    // map.on('exitFullscreen', function () {
    //   console.log('exited fullscreen');
    // });

    // you can also toggle fullscreen from map object
    // map.toggleFullScreen();

  </script>
  <script src="../static/js/project_files/create_route.js"></script>

</body>


</html>